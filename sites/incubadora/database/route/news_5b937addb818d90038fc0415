module.exports = app => {
	const atob = app.require('atob');
	const marked = app.require('marked');


	app.get('/noticias', async (req, res) => getNoticias(req, res, 'sectionNews'));
	app.get('/noticias/dev', async (req, res) => getNoticias(req, res, 'news'));
	

	async function getNoticias(req, res, view) {
		let items = await app.srv.misitiobaApi.browse('articles', {})
		items = items.map(a => {
			try {
				a.html = atob(a.contents);
			} catch (err) {
				a.html = ""
				console.error('ERROR', err.stack)
			}
			return a;
		})
		items = items.filter(i => !i.draft)
		
		items = items.reverse()
		
		res.sendView(view, {
			items,
			lastNews: await app.fn.getLastNews()
		})
	}


	app.get('/:article_name/:type', async (req, res) => {
		let article = await app.srv.misitiobaApi.read('articles', {
			name: {
				$eq: req.params.article_name
			}
		})
		if (article) {
			if (article.draft) {
				if (req.params.type !== 'draft') {
					return res.redirect('/noticias');
				}
			}
		}
		article.html = atob(article.contents);
		res.sendView('single_article', {
			article,
			lastNews: await app.fn.getLastNews(),
			initialState: article
		})
	})

}