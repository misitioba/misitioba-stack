const path = require('path')
const sander = require('sander')
const decodeUriComponent = require('decode-uri-component');

module.exports = app => {
	
	const atob = app.require('atob');
	
	//console.log('WARN [JUST FOR TEST]')
	
	return (req, res, next) => {
		res.sendView = res.sendPugFile = sendPugFile;

	

		try {
			return ((req, res, next) => {
				res.header("Access-Control-Allow-Origin", "*");
				res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
				next();
			})(req,res,next)
		} catch (err) {
			console.error('ERROR [When activating cors]', err.stack)
			next()
		}

		//next();

		function sendPugFile(name, data = {}) {
			try {
				data.decodeUriComponent = decodeUriComponent
				data.atob = atob
				res.send(compilePugFile(name, data, req));
			} catch (err) {
				console.log('ERROR', '[While compiling pug file]', err.stack);
				res.status(500).send(err.stack);
			}

		}

		function compilePugFile(filePath, vars = {}, req) {
			var p = path.join(process.cwd(), 'tmp/pugs', filePath.split('.pug').join(''))
			if (sander.existsSync(p)) {
				return app.require('pug').compileFile(p)(vars)
			} else {
				return "File not found: " + p
			}
		}
	}
}